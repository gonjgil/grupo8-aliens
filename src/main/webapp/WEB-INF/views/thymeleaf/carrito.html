<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ALIENS - Carrito de Compras</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Boostrap core css -->
    <link rel="stylesheet" th:href="@{/webjars/bootstrap/5.2.0/css/bootstrap.min.css}"/>
    <link rel="stylesheet" th:href="@{/css/galeria.css}"/>
</head>

<body class="bg-gray-100 text-gray-800 flex flex-col min-h-screen">
<!-- Header -->
<header class="bg-white p-6 flex justify-between items-center shadow-md">
    <h1 class="text-4xl font-extrabold text-gray-900 tracking-wider">
        <a th:href="@{/galeria}" class="hover:text-blue-600 transition-colors">
            ArtRoom
        </a>
    </h1>

    <div class="flex items-center space-x-4">
        <div th:if="${usuario != null}" class="flex items-center space-x-4">
            <div th:text=" 'Hola, ' + ${usuario.email}"></div>
            <a th:href="@{/logout}"
               class="bg-red-600 hover:bg-red-700 fa-solid fa-right-from-bracket text-white font-bold py-2 px-4 rounded-full transition duration-300 shadow-lg">
            </a>
        </div>
        <div th:unless="${usuario != null}">
            <button
                    th:onclick="|location.href='@{/login}'|"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-full transition duration-300 shadow-lg"
            >
                Iniciar Sesión
            </button>
        </div>
    </div>


</header>

<main class="flex flex-col flex-grow w-full px-4 py-8">
    <div class="container carrito-container">
        <h2 class="text-2xl font-semibold mb-6 text-center">Carrito de Compras</h2>

        <!-- Tabla de productos -->
        <table class="table align-middle">
            <thead class="table-light">
            <tr>
                <th>Obra</th>
                <th>Precio</th>
                <th>Cantidad</th>
                <th>Subtotal</th>
                <th></th>
            </tr>
            </thead>

            <tbody>
            <tr th:each="item : ${items}">
                <td th:text="${item.obraTitulo}"></td>
                <td th:text="'$' + ${#numbers.formatDecimal(item.obraPrecio, 1, 2)}"></td>
                <td>
                    <div class="flex items-center justify-start space-x-2">
                        <form th:action="@{/carrito/disminuir/{id}(id=${item.obraId})}" method="post" style="display:inline">
                            <button type="submit" class="w-8 h-8 flex items-center justify-center
                            bg-gray-200 hover:bg-gray-300 rounded-full text-lg font-bold">-</button>
                        </form>

                        <span class="w-10 text-center font-semibold"><span th:text="${item.cantidad}">1</span></span>

                        <form th:action="@{/carrito/aumentar/{id}(id=${item.obraId})}" method="post" style="display:inline">
                            <button type="submit" class="w-8 h-8 flex items-center justify-center
                            bg-gray-200 hover:bg-gray-300 rounded-full text-lg font-bold">+</button>
                        </form>
                    </div>
                </td>
                <td th:text="'$' + ${#numbers.formatDecimal(item.subtotal, 1, 2)}"></td>
                <td>
                    <form th:action="@{/carrito/eliminar/{obraId}(obraId=${item.obraId})}" method="post">
                        <button type="submit" class="text-red-600 hover:text-red-800 font-semibold">
                            <i class="fas fa-trash mr-2"></i>
                        </button>
                    </form>
                </td>
            </tr>
            </tbody>
        </table>
        <p th:if="${#lists.isEmpty(items)}">Tu carrito esta vacio.</p>

        <div th:if="${!#lists.isEmpty(items)}">
            <!-- Total y botones -->
            <p th:if="${mensaje}" class="alert alert-success mt-3" th:text="${mensaje}">
            <p th:if="${error != null}" class="alert alert-danger mt-3" th:text="${error}">
            <p class="fw-bold text-end fs-5">
                Total: $<span th:text="${#numbers.formatDecimal(total, 1, 2)}"></span>
            </p>
            <div class="d-flex justify-content-between align-items-center mt-4">
                <form th:action="@{/carrito/vaciar}" method="post">
                    <button class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition duration-200" type="submit">Vaciar carrito</button>
                </form>
                <div>
                    <a th:href="@{/galeria}" class="border border-gray-900  text-gray-400 hover:bg-gray-400 hover:text-white font-semibold py-2 px-4 rounded transition duration-200">Seguir comprando</a>
                    <button id="finalizarCompraBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Finalizar compra</button>
                </div>
            </div>
        </div>
    </div>
</main>
<!-- Footer -->
<footer
        class="bg-gray-300 p-6 text-center text-gray-700 mt-12 shadow-inner">
    <p>&copy; 2025 Grupo 8</p>
    <p class="integrantes">Gil - Solodujin - Landín - Santillan - Torrico</p>
</footer>
</body>

<script th:inline="javascript">
    // Solo ejecutar el script si hay items en el carrito
    /*[# th:if="${!#lists.isEmpty(items)}"]*/
    document
      .getElementById('finalizarCompraBtn')
      .addEventListener('click', async () => {
        // Crear array de items basado en las obras del carrito
        const items = [];

        /*[# th:each="item : ${items}"]*/
        items.push({
            id: 'obra-' + /*[[${item.obraId}]]*/ '1',
            title: /*[[${item.obraTitulo}]]*/ 'Obra de arte',
            quantity: /*[[${item.cantidad}]]*/ 1,
            unit_price: /*[[${item.obraPrecio}]]*/ 5000,
        });
        /*[/]*/

        try {
          // Usar la URL correcta de tu aplicación Spring
          const response = await fetch('/spring/api/pagos', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Accept: 'application/json',
            },
            body: JSON.stringify({ items }),
          });

          if (!response.ok) {
            const errorText = await response.text();
            console.error('Error response:', errorText);
            throw new Error(
              `HTTP error! status: ${response.status} - ${errorText}`
            );
          }

          const data = await response.json();

          // Verificar que tenemos la URL de sandbox para testing
          if (data.init_point) {
            // Redirigir al link de Mercado Pago
            window.location.href = data.init_point;
          } else {
            alert(
              'Error al generar el pago: ' +
                (data.error || 'Respuesta inválida')
            );
          }
        } catch (err) {
          console.error('Error completo:', err);
          alert('Error de conexión: ' + err.message);
        }
      });
    /*[/]*/

    // Función para mostrar notificaciones
    function mostrarNotificacion(mensaje, tipo) {
      const tipoClases = {
        success: 'bg-green-100 text-green-700 border border-green-300',
        error: 'bg-red-100 text-red-700 border border-red-300',
        info: 'bg-blue-100 text-blue-700 border border-blue-300',
      };

      const notificacion = document.createElement('div');
      notificacion.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg ${
        tipoClases[tipo] || tipoClases.info
      }`;
      notificacion.innerHTML = `<p>${mensaje}</p>`;

      document.body.appendChild(notificacion);

      // Auto-remover después de 3 segundos
      setTimeout(() => {
        notificacion.style.opacity = '0';
        setTimeout(() => notificacion.remove(), 300);
      }, 3000);
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js"></script>


</html>