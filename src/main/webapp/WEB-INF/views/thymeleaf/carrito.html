<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Carrito de Compras | ArtRoom</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/webjars/bootstrap/5.2.0/css/bootstrap.min.css}"/>
</head>

<body class="bg-gray-100 text-gray-800 flex flex-col min-h-screen">

<header class="bg-gray-900 text-white shadow-md">
    <div class="max-w-7xl mx-auto px-6 py-6 flex justify-between items-center">
        <h1 class="text-4xl font-bold tracking-wide">
            <a th:href="@{/galeria}" class="hover:text-blue-500 transition">ArtRoom</a>
        </h1>

        <div class="flex items-center space-x-6">
            <div th:if="${usuario != null}" class="flex items-center space-x-3 text-gray-200 px-2">
                <span th:text="'Hola, ' + ${usuario.nombre}"></span>

                <a th:href="@{/usuario}" class="bg-gray-200 text-gray-700 hover:bg-green-600 hover:text-white py-2 px-6 rounded-md shadow transition"
                   title="Perfil de usuario">
                    <i class="fa-solid fa-user"></i>
                </a>

                <a th:href="@{/logout}"
                   class="bg-gray-200 text-gray-700 hover:bg-red-600 hover:text-white py-2 px-6 rounded-md shadow transition">
                    <i class="fa-solid fa-right-from-bracket"></i>
                </a>
            </div>

            <div th:unless="${usuario != null}">
                <button th:onclick="|location.href='@{/login}'|"
                        class="bg-gray-200 text-gray-700 hover:bg-blue-600 hover:text-white font-semibold py-2 px-6 rounded-md shadow transition">
                    Iniciar Sesión
                </button>
            </div>
        </div>
    </div>
</header>

<main class="flex flex-col flex-grow w-full px-4 py-10 max-w-7xl mx-auto">

    <h2 class="text-4xl font-semibold mb-10 text-gray-800 text-center">Carrito de Compras</h2>

    <div class="bg-white shadow-xl rounded-lg p-6">

        <div class="overflow-x-auto">
            <table class="table table-borderless align-middle">
                <thead class="bg-gray-100 border-b">
                <tr class="text-gray-600 uppercase text-sm tracking-wider">
                    <th>Obra</th>
                    <th>Formato</th>
                    <th>Precio</th>
                    <th class="text-center">Cantidad</th>
                    <th>Subtotal</th>
                    <th></th>
                </tr>
                </thead>

                <tbody>
                <tr th:each="item : ${items}" class="border-b hover:bg-gray-50 transition">

                    <td class="font-medium" th:text="${item.obraTitulo}"></td>

                    <td>
                        <span class="badge bg-secondary px-3 py-2" th:text="${item.formatoNombre}"></span>
                    </td>

                    <td class="font-semibold text-gray-700"
                        th:text="'$' + ${#numbers.formatDecimal(item.obraPrecio,1,2)}"></td>

                    <td>
                        <div class="flex justify-center items-center space-x-3">

                            <form th:action="@{/carrito/disminuir/{id}(id=${item.obraId})}" method="post">
                                <input type="hidden" name="formato" th:value="${item.formato}" />
                                <button class="w-8 h-8 bg-gray-200 hover:bg-gray-300 rounded-full text-lg font-bold flex items-center justify-center">-</button>
                            </form>

                            <span class="text-lg font-semibold" th:text="${item.cantidad}">1</span>

                            <form th:action="@{/carrito/aumentar/{id}(id=${item.obraId})}" method="post">
                                <input type="hidden" name="formato" th:value="${item.formato}" />
                                <button class="w-8 h-8 bg-gray-200 hover:bg-gray-300 rounded-full text-lg font-bold flex items-center justify-center">+</button>
                            </form>

                        </div>
                    </td>

                    <td class="font-semibold text-gray-700"
                        th:text="'$' + ${#numbers.formatDecimal(item.subtotal,1,2)}"></td>

                    <td>
                        <form th:action="@{/carrito/eliminar/{obraId}(obraId=${item.obraId})}" method="post">
                            <input type="hidden" name="formato" th:value="${item.formato}" />
                            <button class="text-red-600 hover:text-red-800 transition">
                                <i class="fas fa-trash text-xl"></i>
                            </button>
                        </form>
                    </td>

                </tr>
                </tbody>
            </table>
        </div>

        <p th:if="${#lists.isEmpty(items)}" class="text-center text-gray-500 py-4">
            Tu carrito está vacío.
        </p>

        <div th:if="${!#lists.isEmpty(items)}" class="mt-8">

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">

                <div class="bg-gray-50 rounded-lg p-6 shadow-inner">

                    <h3 class="font-semibold text-lg mb-3">Dirección de envío</h3>

                    <div th:if="${direccion != null}">
                        <p class="text-gray-700" th:text="${direccion.nombreCalle} + ' ' + ${direccion.altura}"></p>
                        <p class="text-gray-700" th:text="${direccion.codigoPostal} + ', ' + ${direccion.ciudadBarrio}"></p>

                        <a th:href="@{/usuario/direcciones}"
                           class="text-blue-600 hover:underline mt-2 inline-block">
                            Cambiar dirección
                        </a>
                    </div>

                    <div th:if="${direccion == null}">
                        <p class="text-red-600">Debes agregar una dirección para calcular el envío.</p>
                        <a th:href="@{/usuario/direcciones}"
                           class="text-blue-600 hover:underline">
                            Agregar dirección
                        </a>
                    </div>

                </div>
                <div class="bg-gray-50 rounded-lg p-6 shadow-inner text-right">

                    <p class="text-lg font-semibold mb-2">
                        Productos: $<span th:text="${#numbers.formatDecimal(total,1,2)}"></span>
                    </p>

                    <p class="text-lg font-semibold mb-2">
                        Envío: $<span th:text="${#numbers.formatDecimal(costoEnvio,1,2)}"></span>
                    </p>

                    <p class="text-2xl font-bold mt-4">
                        Total: $<span th:text="${#numbers.formatDecimal(totalFinal,1,2)}"></span>
                    </p>

                </div>

            </div>

            <div class="flex justify-between mt-8">
                <form th:action="@{/carrito/vaciar}" method="post">
                    <button class="bg-gray-200 text-gray-700 border border-gray-300
                                   hover:bg-red-600 hover:text-white
                                   font-semibold py-2 px-5 rounded-md shadow transition">
                        Vaciar carrito
                    </button>
                </form>

                <div class="space-x-3">
                    <a th:href="@{/galeria}"
                       class="bg-gray-200 border border-gray-300 text-gray-700
                              hover:bg-gray-900 hover:text-white
                              font-semibold py-2 px-5 rounded-md transition">
                        Seguir comprando
                    </a>
                    <form th:action="@{/carrito/finalizar}" method="post" class="inline">
                        <button id="finalizarCompraBtn" type="button"
                                class="bg-gray-200 text-gray-700 border border-gray-300
               hover:bg-blue-600 hover:text-white
               font-semibold py-2 px-5 rounded-md shadow transition">
                            Finalizar compra
                        </button>
                    </form>

                </div>

            </div>

        </div>

        <p th:if="${mensaje}" class="alert alert-success mt-4" th:text="${mensaje}"></p>
        <p th:if="${error}" class="alert alert-danger mt-4" th:text="${error}"></p>

    </div>

</main>

<footer class="bg-gray-500 text-gray-200 py-6 mt-12 text-center shadow-inner">
    <p>&copy; 2025 Grupo 8</p>
    <p class="text-gray-900 text-sm">Gil - Solodujin - Landín - Santillan - Torrico</p>
</footer>

</body>

<script>
    function calcularEnvio() {
        const cp = document.getElementById("cpInput").value;

        fetch('/spring/carrito/calcular-envio', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `cp=${cp}`
        })
            .then(r => r.json())
            .then(data => {
                if (data === -1) {
                    document.getElementById("resultadoEnvio").textContent =
                        "Debes iniciar sesión.";
                    return;
                }

                document.getElementById("envioMonto").textContent = data;
                document.getElementById("resultadoEnvio").textContent =
                    "Costo de envío: $" + data;

                const totalProductos = parseFloat(
                    document.getElementById("totalProductos").textContent
                );

                const totalFinal = totalProductos + data;
                document.getElementById("totalFinal").textContent = totalFinal.toFixed(2);
            })
            .catch(err => console.error(err));
    }
</script>


<script th:inline="javascript">
    /*[# th:if="${!#lists.isEmpty(items)}"]*/
    document
      .getElementById('finalizarCompraBtn')
      .addEventListener('click', async () => {

        const items = [];

        /*[# th:each="item : ${items}"]*/
        items.push({
            id: 'obra-' + /*[[${item.obraId}]]*/ '1',
            title: /*[[${item.obraTitulo}]]*/ 'Obra de arte',
            quantity: /*[[${item.cantidad}]]*/ 1,
            unit_price: /*[[${item.obraPrecio}]]*/ 5000,
        });
        /*[/]*/

          const costoEnvio = /*[[${costoEnvio}]]*/ 0;

          items.push({
              id: 'envio',
              title: 'Costo de envío',
              quantity: 1,
              unit_price: costoEnvio
          });

        try {
          // Usar la URL correcta de tu aplicación Spring
          const response = await fetch('/spring/api/pagos-carrito', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Accept: 'application/json',
            },
            body: JSON.stringify({ items }),
          });

          if (!response.ok) {
            const errorText = await response.text();
            console.error('Error response:', errorText);
            throw new Error(
              `HTTP error! status: ${response.status} - ${errorText}`
            );
          }

          const data = await response.json();

          // Verificar que tenemos la URL de sandbox para testing
          if (data.init_point) {
            // Redirigir al link de Mercado Pago
            window.location.href = data.init_point;
          } else {
            alert(
              'Error al generar el pago: ' +
                (data.error || 'Respuesta inválida')
            );
          }
        } catch (err) {
          console.error('Error completo:', err);
          alert('Error');
        }
      });
    /*[/]*/

    // Función para mostrar notificaciones
    function mostrarNotificacion(mensaje, tipo) {
      const tipoClases = {
        success: 'bg-green-100 text-green-700 border border-green-300',
        error: 'bg-red-100 text-red-700 border border-red-300',
        info: 'bg-blue-100 text-blue-700 border border-blue-300',
      };

      const notificacion = document.createElement('div');
      notificacion.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg ${
        tipoClases[tipo] || tipoClases.info
      }`;
      notificacion.innerHTML = `<p>${mensaje}</p>`;

      document.body.appendChild(notificacion);

      // Auto-remover después de 3 segundos
      setTimeout(() => {
        notificacion.style.opacity = '0';
        setTimeout(() => notificacion.remove(), 300);
      }, 3000);
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js"></script>


</html>